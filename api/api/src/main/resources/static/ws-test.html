<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>WS + Redis Test</title>
    <style>
      body { font: 14px/1.4 system-ui, sans-serif; margin: 20px; }
      pre { background:#f7f7f7; padding:12px; border-radius:8px; }
      .row { border:1px solid #ddd; border-radius:8px; padding:8px; margin-top:8px; }
      .ok { color: green; } .warn { color: orange; } .bad { color: red; }
      button { margin-right: 8px; }
    </style>
  </head>
  <body>
    <h2>WebSocket / Redis Tester</h2>

    <div>
      <button id="start">Start Stream</button>
      <button id="stop">Stop Stream</button>
      <button id="send">Send One Test Event</button>
    </div>

    <h3>Status</h3>
    <pre id="log"></pre>

    <h3>Events</h3>
    <div id="events"></div>

    <!-- SockJS + STOMP via CDN -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7.0.0/bundles/stomp.umd.min.js"></script>
    <script>
      const logEl = document.getElementById('log');
      const feedEl = document.getElementById('events');
      const log = (...a) => (logEl.textContent += a.join(' ') + '\n');

      // Connect to /ws (must match your WebSocketConfig endpoint)
      const socket = new SockJS('/ws');
      const client = new StompJs.Client({
        webSocketFactory: () => socket,
        reconnectDelay: 1000,
        onConnect: () => {
          log('CONNECTED to /ws');
          client.subscribe('/topic/stream', (msg) => {
            const ev = JSON.parse(msg.body);
            const div = document.createElement('div');
            const color = ev.decision === 'APPROVE' ? 'ok' :
                          ev.decision === 'REVIEW'  ? 'warn' : 'bad';
            div.className = 'row';
            div.innerHTML = `
              <div><b>ID:</b> ${ev.id}</div>
              <div><b>MCC:</b> ${ev.mcc}</div>
              <div><b>Amount:</b> $${(ev.amountCents/100).toFixed(2)}</div>
              <div><b>Decision:</b> <span class="${color}">${ev.decision}</span></div>
              <div><b>TS:</b> ${ev.ts}</div>`;
            feedEl.prepend(div);
          });
        },
        onStompError: f => log('STOMP ERROR:', f.headers['message']),
        onWebSocketClose: e => log('WS CLOSED:', e.code, e.reason || '')
      });

      client.activate();

      // Buttons call REST endpoints you built
      document.getElementById('start').onclick = () =>
        fetch('/api/sim/start', { method: 'POST' }).then(()=>log('Start requested'));
      document.getElementById('stop').onclick = () =>
        fetch('/api/sim/stop', { method: 'POST' }).then(()=>log('Stop requested'));
      document.getElementById('send').onclick = () =>
        fetch('/api/test/send', { method: 'POST' }).then(()=>log('Single event requested'));
    </script>
  </body>
</html>
